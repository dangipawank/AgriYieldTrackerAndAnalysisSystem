<!doctype html>
<html>
  <head>
    <title>Edit Yield Record</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <h1>Edit Yield Record</h1>
    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %} {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %} {% endif %} {% endwith %}

    <form method="POST">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <label for="crop_id">Crop:</label>
      <select id="crop_id" name="crop_id" required>
        <option value="">Select Crop</option>
        {% for crop in crops %}
        <option value="{{ crop.CropId }}">{{ crop.CropName }}</option>
        {% endfor %}
      </select>
      <br /><br />

      <label for="season_id">Season:</label>
      <select id="season_id" name="season_id" required>
        <option value="">Select Season</option>
        {% for s in seasons %}
        <option value="{{ s.seasonid }}">{{ s.seasonname }}</option>
        {% endfor %}
      </select>
      <br /><br />

      <label for="district_id">District:</label>
      <select id="district_id" name="district_id" required>
        <option value="">Select District</option>
        {% for d in districts %}
        <option value="{{ d.districtid }}">{{ d.districtname }}</option>
        {% endfor %}
      </select>
      <br /><br />

      <label for="municipality_id">Municipality:</label>
      <select id="municipality_id" name="municipality_id" required>
        <option value="">Select Municipality</option>
        {% for m in municipalities %}
        <option
          value="{{ m.municipalityid }}"
          data-district="{{ m.districtid }}"
        >
          {{ m.municipalityname }}
        </option>
        {% endfor %}
      </select>
      <br /><br />

      <label for="year">Year:</label>
      <input
        type="number"
        id="year"
        name="year"
        required
        value="{{ form_data.year }}"
      />
      <br /><br />

      <label for="area_harvested">Area Harvested (ha):</label>
      <input
        type="number"
        step="0.01"
        id="area_harvested"
        name="area_harvested"
        required
        value="{{ form_data.areaharvested }}"
      />
      <br /><br />

      <label for="yield_amount">Yield Amount (tons/ha):</label>
      <input
        type="number"
        step="0.01"
        id="yield_amount"
        name="yield_amount"
        required
        value="{{ form_data.yieldamount }}"
      />
      <br /><br />

      <label for="production">Production (tons):</label>
      <input
        type="number"
        step="0.01"
        id="production"
        name="production"
        readonly
        required
        value="{{ form_data.production }}"
      />
      <br /><br />

      <button type="submit">Update Yield</button>
      <a href="{{ url_for('main.dashboard') }}">Cancel</a>
    </form>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const cropSelect = document.getElementById("crop_id");
        const seasonSelect = document.getElementById("season_id");
        const districtSelect = document.getElementById("district_id");
        const municipalitySelect = document.getElementById("municipality_id");
        const areaHarvested = document.getElementById("area_harvested");
        const yieldAmount = document.getElementById("yield_amount");
        const production = document.getElementById("production");

        const existingCrop = "{{ form_data.crop_id }}";
        const existingSeason = "{{ form_data.season_id }}";
        const existingDistrict = "{{ form_data.district_id }}";
        const existingMunicipality = "{{ form_data.municipality_id }}";

        if (existingCrop) {
          cropSelect.value = existingCrop;
        }
        if (existingSeason) {
          seasonSelect.value = existingSeason;
        }
        if (existingDistrict) {
          districtSelect.value = existingDistrict;
        }

        function filterMunicipalities(selectedDistrict, preserveSelection) {
          if (!preserveSelection) {
            municipalitySelect.value = "";
          }

          let found = false;
          Array.from(municipalitySelect.options)
            .slice(1)
            .forEach((option) => {
              const districtId = option.dataset.district;
              if (districtId == selectedDistrict) {
                option.hidden = false;
                found = true;
              } else {
                option.hidden = true;
              }
            });

          municipalitySelect.disabled = !found && selectedDistrict !== "";
        }

        if (existingDistrict) {
          filterMunicipalities(existingDistrict, true);
          if (existingMunicipality) {
            municipalitySelect.value = existingMunicipality;
          }
        }

        districtSelect.addEventListener("change", function () {
          filterMunicipalities(districtSelect.value, false);
        });

        function updateProduction() {
          const area = parseFloat(areaHarvested.value) || 0;
          const yieldVal = parseFloat(yieldAmount.value) || 0;
          production.value = (area * yieldVal).toFixed(2);
        }

        areaHarvested.addEventListener("input", updateProduction);
        yieldAmount.addEventListener("input", updateProduction);
      });
    </script>
  </body>
</html>
